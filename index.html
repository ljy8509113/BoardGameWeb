<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebView YouTube Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="referrer" content="origin" />
  
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: #000;
      height: 100%;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #000;
    }

    .player-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 비율 */
      background-color: #000;
    }

    #player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>

  <!-- YouTube IFrame Player API -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>
<div class="container">
  <div class="player-wrapper">
    <div id="player"></div>
  </div>
</div>

<script>
  let player;
  var timerId;
  // 플랫폼 체크
  const isAndroid = !!window.Android;
  const isiOS = !!(window.webkit &&
                   window.webkit.messageHandlers &&
                   window.webkit.messageHandlers.YouTubeBridge);

  
  function getQueryParam(name) {
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }
                   /**
   * JS → 네이티브 공통 브리지
   * Android:
   *   Android.onYouTubeEvent(jsonString)
   * iOS:
   *   window.webkit.messageHandlers.YouTubeBridge.postMessage(object)
   */
  function sendToNative(type, payload) {
    const message = {
      type: type,
      payload: payload || {}
    };

    // Android (JavascriptInterface)
    if (isAndroid && typeof window.Android.onYouTubeEvent === "function") {
      try {
        window.Android.onYouTubeEvent(JSON.stringify(message));
      } catch (_) {}
    }

    // iOS (WKScriptMessageHandler)
    if (isiOS) {
      try {
        window.webkit.messageHandlers.YouTubeBridge.postMessage(message);
      } catch (_) {}
    }
  }

  // YouTube IFrame API 준비 콜백
  function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
      playerVars: {
        autoplay: 0,
        controls: 2,          // 유튜브 기본 컨트롤 노출
        playsinline: 1,       // iOS 인라인 재생
        rel: 0,
        fs: 0,
        enablejsapi: 1,
        origin: "https://devinfo.mubeat.tv", // 반드시 실제 도메인과 일치
        widget_referrer: "https://devinfo.mubeat.tv",
        disablekb: 0,
        iv_load_policy: 3
      },
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange,
        onError: onPlayerError,
        onPlaybackRateChange: onPlayerPlaybackRateChange,
        onPlaybackQualityChange: onPlayerPlaybackQualityChange,
        onApiChange: onApiChange
      }
    });
  }

  function onPlayerReady(event) {
    const duration = event.target.getDuration();
    sendToNative("ready", {
      duration: duration
    });

    const videoIdFromUrl = getQueryParam("v");
    if (videoIdFromUrl) {
      cueVideo(videoIdFromUrl, 0);
    }
  }

  function onPlayerStateChange(event) {
    clearTimeout(timerId);
    let stateName = "UNKNOWN";
    switch (event.data) {
      case YT.PlayerState.UNSTARTED:
        stateName = "UNSTARTED"; 
        break;
      case YT.PlayerState.ENDED:
        stateName = "ENDED"; 
        break;
      case YT.PlayerState.PLAYING:
        stateName = "PLAYING";
        
        startSendCurrentTimeInterval();
        sendVideoData(player);
        break;
      case YT.PlayerState.PAUSED:
        stateName = "PAUSED"; 
        break;
      case YT.PlayerState.BUFFERING:
        stateName = "BUFFERING"; 
        break;
      case YT.PlayerState.CUED:
        stateName = "CUED"; 
        break;
    }

    sendToNative("stateChange", {
      state: stateName,
      rawState: event.data,
      currentTime: player ? player.getCurrentTime() : 0
    });
  }

  function onPlayerError(event) {
    sendToNative("error", {
      code: event.data
    });
  }

  function onPlayerPlaybackRateChange(event) {
    sendToNative("playbackRateChange", {
      code: event.data
    });
  }

  function onPlayerPlaybackQualityChange(event) {
    sendToNative("playbackQualityChange", {
      code: event.data
    });
  }

  function onApiChange(event) {
    sendToNative("apiChange", {
      code: event.data
    });
  }

  function startSendCurrentTimeInterval() {
    timerId = setInterval(function() {
      sendToNative("videoCurrentTime", { time: player.getCurrentTime() });
    }, 100 );
  }

  function sendVideoData(player) {
    sendToNative("duration", { duration: player.getDuration() });
  }
  
  // ===== WebView에서 호출할 공개 API =====

  function playVideo() {
    if (player) player.playVideo();
  }

  function pauseVideo() {
    if (player) player.pauseVideo();
  }

  function stopVideo() {
    if (player) player.stopVideo();
  }

  function seekTo(seconds) {
    if (player) player.seekTo(seconds, true);
  }

  function loadVideo(videoId, startSeconds) {
    if (!player) return;
    const start = typeof startSeconds === "number" ? startSeconds : 0;
    player.loadVideoById(videoId, start);
    sendToNative("videoChanged", {
      videoId: videoId,
      startSeconds: start
    });
  }

  function cueVideo(videoId, startSeconds) {
    if(!player) return;
    const start = typeof startSeconds === "number" ? startSeconds : 0;
    player.cueVideoById(videoId, start);
    sendToNative("videoChanged", {
      videoId: videoId,
      startSeconds: start
    });
  }

  function mute() {
    if (player) player.mute();
  }

  function unMute() {
    if (player) player.unMute();
  }

  function setVolume(volumePercent) {
    if (player) player.setVolume(volumePercent);
  }

  function getCurrentTime() {
    if (!player) return 0;
    return player.getCurrentTime();
  }

  function getDuration() {
    if (!player) return 0;
    return player.getDuration();
  }
</script>
</body>
</html>
